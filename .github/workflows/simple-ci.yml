# ç®€åŒ–çš„GitHub Actions CI/CDå·¥ä½œæµ
# è¿™ä¸ªç‰ˆæœ¬æ›´å®¹æ˜“ç†è§£ï¼Œé€‚åˆé¢è¯•å±•ç¤º

name: Simple CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [main, a6] # æ¨é€åˆ°è¿™äº›åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main] # åˆ›å»ºPRæ—¶è§¦å‘

# å®šä¹‰å·¥ä½œæµä»»åŠ¡
jobs:
  # ä»»åŠ¡1ï¼šä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm" # ç¼“å­˜npmä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "Installing dependencies..."
          npm ci  # ä½¿ç”¨ciç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´
          echo "âœ… Dependencies installed"

      # æ­¥éª¤4ï¼šä»£ç æ ¼å¼æ£€æŸ¥
      - name: ğŸ” Lint code
        run: |
          echo "Running ESLint..."
          npm run lint
          echo "âœ… Linting passed"

      # æ­¥éª¤5ï¼šTypeScriptç±»å‹æ£€æŸ¥
      - name: ğŸ”§ Type check
        run: |
          echo "Running TypeScript check..."
          npm run type-check
          echo "âœ… Type check passed"

      # æ­¥éª¤6ï¼šè¿è¡Œæµ‹è¯•
      - name: ğŸ§ª Run tests
        run: |
          echo "Running tests..."
          npm test -- --watchAll=false --coverage
          echo "âœ… Tests passed"

      # æ­¥éª¤7ï¼šæ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ Build project
        run: |
          echo "Building project..."
          npm run build
          echo "âœ… Build successful"

      # æ­¥éª¤8ï¼šå®‰å…¨æ‰«æ
      - name: ğŸ”’ Security audit
        run: |
          echo "Running security audit..."
          npm audit --audit-level=moderate
          echo "âœ… Security audit passed"

  # ä»»åŠ¡2ï¼šéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: quality-check # ä¾èµ–è´¨é‡æ£€æŸ¥ä»»åŠ¡
    if: github.ref == 'refs/heads/a6' # åªåœ¨a6åˆ†æ”¯éƒ¨ç½²

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      # éƒ¨ç½²åˆ°Netlifyï¼ˆå‰ç«¯ï¼‰
      - name: ğŸš€ Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: "./build"
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "ğŸš€ Deploy from GitHub Actions - Staging"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: ğŸ“¢ Deploy notification
        run: |
          echo "ğŸ‰ Staging deployment completed!"
          echo "ğŸŒ Frontend: https://your-app.netlify.app"
          echo "ğŸ”§ Backend: https://your-backend.onrender.com"

  # ä»»åŠ¡3ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.ref == 'refs/heads/main' # åªåœ¨mainåˆ†æ”¯éƒ¨ç½²
    environment: production # ä½¿ç”¨productionç¯å¢ƒ

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "ğŸ“Š This is a production deployment"
          echo "âœ… Production deployment completed"

      # éƒ¨ç½²é€šçŸ¥
      - name: ğŸ“¢ Production notification
        run: |
          echo "ğŸ‰ Production deployment completed!"
          echo "ğŸŒ Live site: https://your-production-app.com"
          echo "ğŸ“ˆ Monitoring: https://your-monitoring-dashboard.com"
